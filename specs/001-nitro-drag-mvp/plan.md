# Implementation Plan: Nitro Drag Royale MVP

**Branch**: `001-nitro-drag-mvp` | **Date**: 2026-01-28 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-nitro-drag-mvp/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Nitro Drag Royale is a PvP crash tournament racing game implemented as a Telegram Mini App. The MVP is built as a **Modular Monolith in Go** with React/TypeScript frontend, focusing on:

- **Deterministic server-authoritative gameplay** with 10-player matches (3 heats each)
- **Fast matchmaking** (<20s) using Ghost players (historical replays) to fill slots
- **Ledger-based economy** with explicit system wallets for TON/FUEL/BURN currencies
- **Real-time gameplay** via Centrifugo (WebSocket + RPC proxy to Go backend)
- **TON blockchain integration** via TonCenter API for deposits/withdrawals

## Technical Context

**Language/Version**: 
- Backend: Go 1.25+
- Frontend: React 18+ with TypeScript 5+

**Primary Dependencies**:
- Backend: Chi router, pgx/sqlx (PostgreSQL), go-redis, Centrifugo gocent/v3, shopspring/decimal
- Frontend: Vite 5+, Pixi.js 7+, Centrifuge.js, TON Connect UI React, Zustand, React Query

**Storage**: 
- PostgreSQL 17+ (system of record: users, wallets, ledger, matches, payments)
- Redis 7+ (matchmaking queues, idempotency keys, short-lived locks)

**Testing**: 
- Backend: Go testing + testify + dockertest/v3 (integration)
- Frontend: Vitest + React Testing Library

**Target Platform**: 
- Backend: Linux server (DigitalOcean App Platform)
- Frontend: Telegram Mini App (WebView in Telegram mobile clients)
- Real-time: Centrifugo v4 (separate service)

**Project Type**: Web application (backend API + frontend SPA + real-time service)

**Performance Goals**: 
- 100 concurrent matches (1,000 concurrent live players) without degradation
- Matchmaking <20 seconds (95% of attempts)
- Reconnection success within 3 seconds (95%)
- Pixi.js HUD rendering: 30-45 FPS (capped for battery/performance)

**Constraints**: 
- Single backend replica for MVP (no horizontal scaling yet)
- Fixed-point decimal math (DECIMAL(16,2), rounding down/floor only)
- RPC latency budget: <200ms for hot-path commands
- TON deposits/withdrawals: async reconciliation (eventual consistency)
- Telegram Mini App resource limits (2x DPR max, no heavy runtime filters)

**Scale/Scope**: 
- MVP target: 1,000 daily active users
- 4 leagues (Rookie, Street, Pro, Top Fuel)
- 3 currencies (TON, FUEL, BURN)
- 11 functional domains (auth, account, matchmaker, gameengine, ghosts, payments, gateway)
- 85+ functional requirements, 20 success criteria

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

âœ… **I. Golang Style Guide (NON-NEGOTIABLE)**: Backend follows Uber Go Style Guide
- Using Chi router for HTTP routing with route grouping
- Database operations use sqlx.NamedExecContext for struct inserts
- Error handling and package structure follow Uber conventions

âœ… **II. Git Commit Policy (NON-NEGOTIABLE)**: One commit, one task
- Each implementation task will result in a single atomic commit
- Commits will be structured for easy review and potential rollback

âœ… **III. React + TypeScript Technology Stack (NON-NEGOTIABLE)**: TypeScript only
- Frontend uses React 18+ with TypeScript 5+
- No JavaScript files will be used in the frontend codebase

âœ… **IV. Real-Time Communication Architecture**: Centrifugo with gRPC
- Centrifugo v4 handles all WebSocket connections
- Backend communicates with Centrifugo via gRPC API
- JWT tokens generated by backend using HMAC
- Channel permissions enforced via Centrifugo subscription proxy (gRPC)
- Redis used as Centrifugo broker for scalability

âœ… **V. Modular Service Architecture**: Domain-driven modules
- Backend organized into modules: auth, account, matchmaker, gameengine, ghosts, payments, gateway
- Each module has primary Service struct with constructor injection
- Cross-module communication via service interfaces

âœ… **VI. Data Layer Standards**: PostgreSQL + Redis
- PostgreSQL 17+ for persistent data with golang-migrate for schema migrations
- Redis 7+ for caching, matchmaking queues, and Centrifugo broker
- All database operations use sqlx
- Database models in backend/internal/storage/postgres/models/

âœ… **VII. Observability and Metrics**: Prometheus + Structured Logging
- Internal logger package for structured logging
- Prometheus metrics exposed on dedicated metrics port
- HTTP request metrics, business operation metrics, error tracking

**Status**: âœ… ALL GATES PASSED - No constitution violations

## Project Structure

### Documentation (this feature)

```text
specs/001-nitro-drag-mvp/
â”œâ”€â”€ plan.md              # This file (/speckit.plan command output)
â”œâ”€â”€ research.md          # Phase 0 output (/speckit.plan command)
â”œâ”€â”€ data-model.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ quickstart.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ contracts/           # Phase 1 output (/speckit.plan command)
â”‚   â”œâ”€â”€ rpc/             # Centrifugo RPC contracts (Protobuf)
â”‚   â””â”€â”€ http/            # HTTP API contracts (OpenAPI/JSON Schema)
â””â”€â”€ tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
backend/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ server/              # Main entry point (single Go binary)
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ modules/             # Domain modules (Modular Monolith)
â”‚   â”‚   â”œâ”€â”€ auth/            # Telegram auth, JWT issuance
â”‚   â”‚   â”œâ”€â”€ account/         # Wallets, ledger, system wallets
â”‚   â”‚   â”œâ”€â”€ matchmaker/      # Queueing, lobby formation
â”‚   â”‚   â”œâ”€â”€ gameengine/      # In-memory match state machine
â”‚   â”‚   â”œâ”€â”€ ghosts/          # Historical replay loading
â”‚   â”‚   â”œâ”€â”€ payments/        # TON deposits/withdrawals
â”‚   â”‚   â””â”€â”€ gateway/         # HTTP API, Centrifugo publisher, gRPC RPC handlers
â”‚   â”œâ”€â”€ storage/
â”‚   â”‚   â”œâ”€â”€ postgres/        # PostgreSQL DAL
â”‚   â”‚   â”‚   â”œâ”€â”€ models/      # Database models
â”‚   â”‚   â”‚   â”œâ”€â”€ migrations/  # golang-migrate SQL files
â”‚   â”‚   â”‚   â””â”€â”€ repository/  # Repository interfaces/implementations
â”‚   â”‚   â””â”€â”€ redis/           # Redis DAL
â”‚   â”œâ”€â”€ centrifugo/          # Centrifugo gRPC client wrapper
â”‚   â”œâ”€â”€ toncenter/           # TonCenter API client
â”‚   â”œâ”€â”€ logger/              # Structured logging package
â”‚   â””â”€â”€ config/              # 12-factor config (env vars)
â”œâ”€â”€ proto/                   # Protobuf definitions (Centrifugo RPC)
â”‚   â””â”€â”€ centrifugo/
â”‚       â””â”€â”€ rpc.proto
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ integration/         # Integration tests (dockertest)
â”‚   â””â”€â”€ testdata/            # Test fixtures
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml       # Local dev environment
â””â”€â”€ Makefile                 # Dev tasks (make dev, make test, etc.)

frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/          # React components
â”‚   â”‚   â”œâ”€â”€ garage/          # Garage screen components
â”‚   â”‚   â”œâ”€â”€ matchmaking/     # Matchmaking UI
â”‚   â”‚   â”œâ”€â”€ race/            # Race HUD (Pixi.js integration)
â”‚   â”‚   â”œâ”€â”€ settlement/      # Settlement screen
â”‚   â”‚   â””â”€â”€ common/          # Shared UI components
â”‚   â”œâ”€â”€ pages/               # Top-level page components
â”‚   â”œâ”€â”€ services/            # Business logic layer
â”‚   â”‚   â”œâ”€â”€ centrifugo/      # Centrifuge.js client wrapper
â”‚   â”‚   â”œâ”€â”€ api/             # HTTP API client (React Query)
â”‚   â”‚   â””â”€â”€ wallet/          # TON Connect integration
â”‚   â”œâ”€â”€ stores/              # Zustand stores (global state)
â”‚   â”œâ”€â”€ hooks/               # Custom React hooks
â”‚   â”œâ”€â”€ pixi/                # Pixi.js rendering logic
â”‚   â”‚   â”œâ”€â”€ scenes/          # Scene setup (Race HUD)
â”‚   â”‚   â”œâ”€â”€ sprites/         # Sprite management
â”‚   â”‚   â””â”€â”€ utils/           # Pixi utilities
â”‚   â”œâ”€â”€ locales/             # i18n translations (en, ru, es-PE, pt-BR)
â”‚   â”œâ”€â”€ types/               # TypeScript type definitions
â”‚   â””â”€â”€ utils/               # Frontend utilities
â”œâ”€â”€ public/
â”‚   â””â”€â”€ assets/              # Static assets (images, spritesheets)
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/                # Unit tests (Vitest)
â”‚   â””â”€â”€ components/          # Component tests (React Testing Library)
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ tsconfig.json
â””â”€â”€ package.json

deployments/
â”œâ”€â”€ centrifugo/
â”‚   â””â”€â”€ config.json          # Centrifugo v4 configuration
â””â”€â”€ docker-compose.yml       # Local infrastructure (PostgreSQL, Redis, Centrifugo)
```

**Structure Decision**: **Web application** (Option 2) with backend Go monolith, frontend React SPA, and separate real-time service (Centrifugo). The backend is structured as a **Modular Monolith** following Domain-Driven Design principles with modules in `backend/internal/modules/`. The frontend follows a layered architecture with clear separation between UI components, business logic (services), and state management (Zustand stores).

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**No constitution violations** â€” All architectural decisions align with NDR Constitution principles.

### Complexity Justifications (Non-violations)

The following architectural choices add complexity but are **necessary for MVP requirements**:

| Complexity | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| Centrifugo (separate service) | Hot-path gameplay commands require <200ms latency + connection management for 1,000 concurrent users | WebSocket in Go backend: Centrifugo provides production-ready connection management, presence tracking, Redis scaling, and RPC proxy out-of-box |
| Fixed-point decimal math | Economy safety requires deterministic rounding (no floating point errors for TON/FUEL/BURN) | Floating point: Accumulates rounding errors in ledger operations, violates economic correctness |
| Ghost players system | Fast matchmaking (<20s) requires filling lobbies when <10 live players available | Wait for 10 live players: Would violate Design Pillar #1 (Fast Sessions) and kill retention in MVP with low player count |
| Ledger-based economy | Audit trail required for TON deposits/withdrawals, system wallets must balance (sum of deltas = 0) | Direct balance updates: No audit trail, impossible to debug economy bugs, no reconciliation with blockchain |
| Modular monolith | 11 functional domains require clear boundaries, but horizontal scaling not needed in MVP | Microservices: Premature for MVP, adds deployment complexity; Single `main.go`: Unmaintainable with 11 domains |

---

## Phase 0: Research (COMPLETE)

All technical decisions documented in [research.md](./research.md).

**Key Decisions**:
- Backend: Go 1.25+ with Chi router
- Real-time: Centrifugo v4 + Redis + gRPC proxy
- Database: PostgreSQL 17+ (persistent) + Redis 7+ (volatile)
- Frontend: React 18+ with TypeScript 5+, Vite 5+, Pixi.js 7+
- Authentication: Telegram initData validation + Dual JWT (App + Centrifugo)
- Blockchain: TON via TonCenter API + async reconciliation
- Deployment: DigitalOcean App Platform + Managed Services
- Testing: Go testing + testify + dockertest (backend), Vitest + React Testing Library (frontend)
- Observability: Prometheus + Logrus + Sentry
- Localization: Frontend-only i18n (en, ru, es-PE, pt-BR)
- Analytics: Amplitude (client-side SDK)

**No unresolved NEEDS CLARIFICATION items** â€” All technical unknowns resolved.

---

## Phase 1: Design & Contracts (COMPLETE)

### Artifacts Generated

1. **Data Model** ([data-model.md](./data-model.md))
   - 9 PostgreSQL entities with complete schemas
   - Relationships, constraints, indexes documented
   - Fixed-point decimal rules and ledger invariants defined
   - Migration strategy outlined

2. **RPC Contracts** ([contracts/rpc/](./contracts/rpc/))
   - `matchmaking.proto` â€” Join/cancel matchmaking queue
   - `match.proto` â€” In-match actions (earn points, give up)
   - Centrifugo RPC â†’ gRPC proxy protocol
   - Error codes, idempotency, authentication documented

3. **HTTP API Contracts** ([contracts/http/](./contracts/http/))
   - `auth.json` â€” Telegram authentication (JWT issuance)
   - `garage.json` â€” Garage state (balances, league access)
   - `payments.json` â€” TON deposits/withdrawals, payment history
   - OpenAPI 3.0 format with error responses, pagination, decimal string format

4. **Event Contracts** ([contracts/events/](./contracts/events/))
   - Personal channel (`user:{user_id}`) events
   - Match channel (`match:{match_id}`) events
   - Event schemas (balance_updated, match_found, heat_started, match_settled, etc.)
   - TypeScript type generation guidance

5. **Quickstart Guide** ([quickstart.md](./quickstart.md))
   - Prerequisites and installation
   - Local development environment setup (Docker Compose)
   - Database migrations workflow
   - Code generation from contracts (Protobuf, OpenAPI)
   - Development workflow (backend + frontend)
   - Common tasks and troubleshooting
   - Makefile targets reference

6. **Agent Context** (`.cursor/rules/specify-rules.mdc`)
   - Technology stack registered for Cursor IDE
   - Constitution principles embedded for AI-assisted development

### Constitution Check (Post-Design)

âœ… **PASS** â€” All 7 constitution principles remain satisfied:
- âœ… I. Golang Style Guide (Uber Go, Chi router, sqlx)
- âœ… II. Git Commit Policy (one commit, one task)
- âœ… III. React + TypeScript (mandatory, no JavaScript)
- âœ… IV. Real-Time Architecture (Centrifugo + Redis + gRPC proxy)
- âœ… V. Modular Service Architecture (11 domain modules)
- âœ… VI. Data Layer Standards (PostgreSQL 17+, Redis 7+, migrations)
- âœ… VII. Observability & Metrics (Prometheus, structured logging)

---

## Next Steps

**Phase 2: Task Breakdown** â€” Run `/speckit.tasks` to generate implementation tasks from this plan.

Expected task categories:
- **Infrastructure**: Docker setup, migrations, seed data
- **Backend Modules**: Auth, account, matchmaker, gameengine, ghosts, payments, gateway
- **Frontend Components**: Garage, matchmaking, race HUD (Pixi.js), settlement
- **Real-time Integration**: Centrifugo client, event handling, RPC commands
- **Testing**: Unit tests, integration tests (dockertest), component tests
- **Observability**: Prometheus metrics, structured logging, Sentry integration

**Ready for Implementation** ðŸš€
